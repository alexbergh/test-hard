services:
  # Docker Socket Proxy for security - limits scanner access
  docker-proxy:
    image: tecnativa/docker-socket-proxy:0.1.2
    container_name: docker-proxy
    environment:
      CONTAINERS: 1
      EXEC: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      VOLUMES: 1
      POST: 1
      SERVICES: 1
      TASKS: 1
      VERSION: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - scanner-net
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

  target-fedora:
    image: registry.fedoraproject.org/fedora:40
    container_name: target-fedora
    command: ["sleep", "infinity"]
  target-debian:
    image: debian:12-slim
    container_name: target-debian
    command: ["sleep", "infinity"]
  target-centos:
    image: quay.io/centos/centos:stream9
    container_name: target-centos
    command: ["sleep", "infinity"]
  target-ubuntu:
    image: ubuntu:22.04
    container_name: target-ubuntu
    command: ["sleep", "infinity"]
  target-alt-c10f2:
    image: registry.altlinux.org/alt/alt:c10f2
    container_name: target-alt-c10f2
    command: ["sleep", "infinity"]
  target-alt-latest:
    image: registry.altlinux.org/alt/alt:latest
    container_name: target-alt-latest
    command: ["sleep", "infinity"]
  openscap-scanner:
    image: ghcr.io/alexbergh/test-hard:${VERSION:-latest}
    container_name: openscap-scanner
    command: scan-openscap
    # SECURITY: Using specific capabilities instead of privileged mode
    cap_add:
      - SYS_PTRACE      # Required for process inspection
      - SYS_ADMIN       # Required for mount namespace operations
      - NET_ADMIN       # Required for network scanning
      - AUDIT_CONTROL   # Required for audit operations
    cap_drop:
      - ALL             # Drop all capabilities first, then add only needed ones
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for some scanning operations
    environment:
      TARGET_CONTAINERS: target-fedora target-debian target-centos target-ubuntu target-alt-c10f2 target-alt-latest
      DOCKER_HOST: tcp://docker-proxy:2375
      HARDENING_RESULTS_DIR: /reports
      RESULT_ROOT: /reports
    volumes:
      - ./reports:/reports
      # SECURITY: Removed direct docker.sock mount - using docker-proxy instead
    networks:
      - default
      - scanner-net
    depends_on:
      - docker-proxy
      - target-fedora
      - target-debian
      - target-centos
      - target-ubuntu
      - target-alt-c10f2
      - target-alt-latest
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
  lynis-scanner:
    image: ghcr.io/alexbergh/test-hard:${VERSION:-latest}
    container_name: lynis-scanner
    command: scan-lynis
    # SECURITY: Using specific capabilities instead of privileged mode
    cap_add:
      - SYS_PTRACE      # Required for process inspection
      - SYS_ADMIN       # Required for filesystem checks
      - NET_ADMIN       # Required for network checks
      - AUDIT_READ      # Required for reading audit logs
    cap_drop:
      - ALL             # Drop all capabilities first, then add only needed ones
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined  # Required for some scanning operations
    environment:
      TARGET_CONTAINERS: target-fedora target-debian target-centos target-ubuntu target-alt-c10f2 target-alt-latest
      DOCKER_HOST: tcp://docker-proxy:2375
      HARDENING_RESULTS_DIR: /reports
      RESULT_ROOT: /reports
    volumes:
      - ./reports:/reports
      # SECURITY: Removed direct docker.sock mount - using docker-proxy instead
    networks:
      - default
      - scanner-net
    depends_on:
      - docker-proxy
      - target-fedora
      - target-debian
      - target-centos
      - target-ubuntu
      - target-alt-c10f2
      - target-alt-latest
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
  telegraf:
    image: ghcr.io/alexbergh/test-hard:${VERSION:-latest}
    container_name: telegraf
    command: telegraf
    volumes:
      - /tmp/test_metrics:/tmp/test_metrics:ro
      - ./reports:/reports:ro
    ports:
      - "9091:9091"
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/metrics"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 256M
  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: alertmanager
    command:
      - "--config.file=/etc/alertmanager/config.yml"
    volumes:
      - ./prometheus/alertmanager.yml:/etc/alertmanager/config.yml:ro
    ports:
      - "9093:9093"
    networks:
      - default
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:9093/-/healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
  prometheus:
    image: prom/prometheus:v2.52.0
    container_name: prometheus
    hostname: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=${PROMETHEUS_RETENTION_TIME:-30d}"
      - "--storage.tsdb.retention.size=${PROMETHEUS_RETENTION_SIZE:-10GB}"
      - "--web.listen-address=0.0.0.0:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus-data:/prometheus
    depends_on:
      - telegraf
      - alertmanager
    ports:
      - "9090:9090"
    networks:
      default:
        aliases:
          - prometheus
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
  grafana:
    image: grafana/grafana:11.0.0
    container_name: grafana
    environment:
      GF_SECURITY_ADMIN_USER: ${GF_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD:-admin}
      GF_AUTH_BASIC_ENABLED: ${GF_AUTH_BASIC_ENABLED:-true}
      GF_AUTH_DISABLE_LOGIN_FORM: ${GF_AUTH_DISABLE_LOGIN_FORM:-false}
      GF_FEATURE_TOGGLES_ENABLE: logsInExplore
      GF_LOG_LEVEL: ${GF_LOG_LEVEL:-debug}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
      - loki
    links:
      - prometheus:prometheus
      - loki:loki
    ports:
      - "${GRAFANA_HOST_PORT:-3000}:3000"
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M
  # Centralized Logging - Loki
  loki:
    image: grafana/loki:2.9.0
    container_name: loki
    ports:
      - "3100:3100"
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          cpus: '0.50'
          memory: 512M

  # Log collector - Promtail
  promtail:
    image: grafana/promtail:2.9.0
    container_name: promtail
    volumes:
      - ./loki/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${REPORTS_DIR:-./reports}:/reports:ro
    command: -config.file=/etc/promtail/config.yml
    networks:
      - default
    depends_on:
      - loki
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 256M

networks:
  default:
    driver: bridge
  scanner-net:
    driver: bridge
    internal: false

volumes:
  grafana-data: {}
  prometheus-data: {}
  loki-data: {}
