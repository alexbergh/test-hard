version: "3.8"

services:
  ##############################################################################
  # OpenSCAP
  ##############################################################################
  openscap-runner:
    image: deepsecurity/openscap-scan:1.2.83
    container_name: openscap-runner
    pull_policy: if_not_present
    restart: unless-stopped
    command: ["sh", "-lc", "sleep infinity"]
    volumes:
      - ./artifacts:/artifacts
    healthcheck:
      test: ["CMD-SHELL", "echo ok"]
      interval: 30s
      timeout: 5s
      retries: 5

  ##############################################################################
  # Telemetry stack
  ##############################################################################
  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    pull_policy: if_not_present
    restart: unless-stopped
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: admin
      DOCKER_INFLUXDB_INIT_PASSWORD: adminadmin
      DOCKER_INFLUXDB_INIT_ORG: test
      DOCKER_INFLUXDB_INIT_BUCKET: telemetry
      DOCKER_INFLUXDB_INIT_RETENTION: 4w
    volumes:
      - influxdb-data:/var/lib/influxdb2
    ports:
      - "8086:8086"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8086/health | grep -q pass"]
      interval: 15s
      timeout: 5s
      retries: 30

  telegraf-listener:
    image: telegraf:1.29
    container_name: telegraf-listener
    pull_policy: if_not_present
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    volumes:
      - ./config/telegraf:/etc/telegraf:ro
    healthcheck:
      test: ["CMD-SHELL", "telegraf --version >/dev/null 2>&1"]
      interval: 30s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:10.4.1
    container_name: grafana
    pull_policy: if_not_present
    restart: unless-stopped
    depends_on:
      influxdb:
        condition: service_healthy
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: adminadmin
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/health | grep -q healthy"]
      interval: 15s
      timeout: 5s
      retries: 30

  ##############################################################################
  # Wazuh stack
  ##############################################################################
  wazuh-indexer:
    image: local/wazuh-indexer:dev
    container_name: wazuh-indexer
    pull_policy: if_not_present
    restart: unless-stopped
    user: "1000:1000"
    environment:
      - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
      - DISABLE_SECURITY_PLUGIN=false
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
      # корректный путь для конфига — в корень, не в "config/"
      - ./config/wazuh-indexer/opensearch.yml:/usr/share/wazuh-indexer/opensearch.yml:ro
      - ./config/wazuh-indexer/certs:/usr/share/wazuh-indexer/certs:ro
      - wazuh-indexer-logs:/var/log/wazuh-indexer
    ports:
      - "9200:9200"
    healthcheck:
      test: >
        CMD-SHELL curl -fsS --cacert /etc/wazuh-indexer/certs/root-ca.pem
        -u admin:${WAZUH_INDEXER_PASSWORD}
        https://localhost:9200/_cluster/health?pretty >/dev/null || exit 1
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh-manager:
    image: wazuh/wazuh-manager:4.13.1
    container_name: wazuh-manager
    pull_policy: if_not_present
    restart: unless-stopped
    depends_on:
      wazuh-indexer:
        condition: service_healthy
    environment:
      WAZUH_INDEXER_URL: https://wazuh-indexer:9200
      WAZUH_INDEXER_USER: admin
      WAZUH_INDEXER_PASSWORD: ${WAZUH_INDEXER_PASSWORD}
      WAZUH_API_USER: admin
      WAZUH_API_PASSWORD: ${WAZUH_API_PASSWORD}
      INDEXER_URL: https://wazuh-indexer:9200
      INDEXER_USERNAME: admin
      INDEXER_PASSWORD: ${WAZUH_INDEXER_PASSWORD}
      INDEXER_SSL_VERIFICATION: "false"
    volumes:
      # Каталог с api.yaml и SSL для API
      - ./config/wazuh-manager:/var/ossec/api/configuration:ro
      # Том с данными менеджера
      - wazuh-manager-data:/var/ossec/data
    ports:
      - "1514:1514/udp"
      - "1515:1515"
      - "55000:55000"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSk -u admin:${WAZUH_API_PASSWORD} https://localhost:55000/manager/status >/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh-dashboard:
    image: wazuh/wazuh-dashboard:4.13.1
    container_name: wazuh-dashboard
    pull_policy: if_not_present
    restart: unless-stopped
    depends_on:
      wazuh-indexer:
        condition: service_healthy
      wazuh-manager:
        condition: service_healthy
    ports:
      - "443:5601"
    environment:
      OPENSEARCH_HOSTS: '["https://wazuh-indexer:9200"]'
      OPENSEARCH_USERNAME: admin
      OPENSEARCH_PASSWORD: ${WAZUH_INDEXER_PASSWORD}
      OPENSEARCH_DASHBOARDS_USERNAME: admin
      OPENSEARCH_DASHBOARDS_PASSWORD: ${WAZUH_API_PASSWORD}
      WAZUH_API_URL: https://wazuh-manager:55000
      API_USERNAME: admin
      API_PASSWORD: ${WAZUH_API_PASSWORD}
    volumes:
      - ./config/wazuh-dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsSk https://localhost:5601/api/status | grep -q available"]
      interval: 30s
      timeout: 10s
      retries: 5

  wazuh-agent:
    image: wazuh/wazuh-agent:4.13.1
    container_name: wazuh-agent
    pull_policy: if_not_present
    restart: unless-stopped
    depends_on:
      wazuh-manager:
        condition: service_healthy
    environment:
      - WAZUH_MANAGER=wazuh-manager
      - WAZUH_AGENT_NAME=docker-test-agent
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[w]azuh-agentd'"]
      interval: 30s
      timeout: 5s
      retries: 5

volumes:
  influxdb-data:
  grafana-data:
  wazuh-manager-data:
  wazuh-indexer-data:
  wazuh-indexer-logs:
