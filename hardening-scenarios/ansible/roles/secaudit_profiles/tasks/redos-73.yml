---
- name: Configure SSH root login policy (RedOS 7.3)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^PermitRootLogin'
    line: 'PermitRootLogin no'
    state: present
    create: yes
  notify: restart sshd

- name: Restrict SSH ciphers (RedOS 7.3)
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: '^Ciphers'
    line: 'Ciphers aes256-ctr,aes192-ctr,aes128-ctr'
    create: yes
  notify: restart sshd

- name: Ensure osquery hardening pack exists
  ansible.builtin.copy:
    dest: /opt/osquery/packs/hardening.conf
    content: |
      # autogenerated by secaudit_profiles
      schedule = {
        integrity_check = {
          query = "select * from osquery_schedule";
          interval = 3600;
        }
      }
    owner: root
    group: root
    mode: "0644"
  notify: restart osqueryd

- name: Configure auditd remote forwarding (RedOS 7.3)
  ansible.builtin.blockinfile:
    path: /etc/audisp/plugins.d/au-remote.conf
    block: |
      active = yes
      remote_server = {{ (secaudit_target_environment == 'prod') | ternary('syslog.prod.local', 'syslog.test.local') }}
      transport = tcp
    owner: root
    group: root
    mode: "0640"
  notify: restart auditd

- name: Tune password policy (RedOS 7.3)
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MAX_DAYS'
    line: "PASS_MAX_DAYS {{ (secaudit_target_environment == 'prod') | ternary('60', '90') }}"
    state: present

- name: Ensure PASS_MIN_DAYS is set
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_MIN_DAYS'
    line: "PASS_MIN_DAYS {{ (secaudit_target_environment == 'prod') | ternary('1', '0') }}"
    state: present

- name: Ensure PASS_WARN_AGE is set
  ansible.builtin.lineinfile:
    path: /etc/login.defs
    regexp: '^PASS_WARN_AGE'
    line: "PASS_WARN_AGE {{ (secaudit_target_environment == 'prod') | ternary('14', '7') }}"
    state: present
