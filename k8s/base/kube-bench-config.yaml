# kube-bench custom configuration for CIS Kubernetes Benchmark
# Based on CIS Kubernetes Benchmark v1.12.0
#
# Usage:
#   kube-bench --config kube-bench-config.yaml
#   kube-bench run --targets master --config kube-bench-config.yaml
#
# Covers: Control Plane files, API Server, Controller Manager,
#         Scheduler, ETCD (106 parameters total)

id: custom
text: CIS Kubernetes Benchmark v1.12.0 - test-hard
type: master
version: cis-1.12

groups:
# ──────────────────────────────────
# 1. Control Plane Files
# ──────────────────────────────────
- id: '1'
  text: Control Plane Files
  checks:
  - id: '1.1'
    text: "API server pod specification file permissions (644)"
    audit: stat -c %a /etc/kubernetes/manifests/kube-apiserver.yaml
    remediation: "chmod 644 /etc/kubernetes/manifests/kube-apiserver.yaml"
    scored: true
    tests:
      test_items:
      - flag: "644"
        compare:
          op: eq
          value: "644"
        set: true

  - id: '1.2'
    text: "API server pod specification file ownership (root:root)"
    audit: stat -c %U:%G /etc/kubernetes/manifests/kube-apiserver.yaml
    remediation: "chown root:root /etc/kubernetes/manifests/kube-apiserver.yaml"
    scored: true
    tests:
      test_items:
      - flag: "root:root"
        set: true

  - id: '1.3'
    text: "Controller Manager pod specification permissions (644)"
    audit: stat -c %a /etc/kubernetes/manifests/kube-controller-manager.yaml
    remediation: "chmod 644 /etc/kubernetes/manifests/kube-controller-manager.yaml"
    scored: true
    tests:
      test_items:
      - flag: "644"
        compare:
          op: eq
          value: "644"
        set: true

  - id: '1.4'
    text: "Scheduler pod specification permissions (644)"
    audit: stat -c %a /etc/kubernetes/manifests/kube-scheduler.yaml
    remediation: "chmod 644 /etc/kubernetes/manifests/kube-scheduler.yaml"
    scored: true
    tests:
      test_items:
      - flag: "644"
        compare:
          op: eq
          value: "644"
        set: true

  - id: '1.5'
    text: "etcd pod specification permissions (644)"
    audit: stat -c %a /etc/kubernetes/manifests/etcd.yaml
    remediation: "chmod 644 /etc/kubernetes/manifests/etcd.yaml"
    scored: true
    tests:
      test_items:
      - flag: "644"
        compare:
          op: eq
          value: "644"
        set: true

  - id: '1.6'
    text: "CNI configuration file permissions"
    audit: stat -c %a /etc/cni/net.d/*
    remediation: "chmod 644 /etc/cni/net.d/*"
    scored: true
    tests:
      test_items:
      - flag: "644"
        set: true

  - id: '1.7'
    text: "admin.conf file permissions (600)"
    audit: stat -c %a /etc/kubernetes/admin.conf
    remediation: "chmod 600 /etc/kubernetes/admin.conf"
    scored: true
    tests:
      test_items:
      - flag: "600"
        compare:
          op: eq
          value: "600"
        set: true

  - id: '1.8'
    text: "scheduler.conf file permissions (600)"
    audit: stat -c %a /etc/kubernetes/scheduler.conf
    remediation: "chmod 600 /etc/kubernetes/scheduler.conf"
    scored: true
    tests:
      test_items:
      - flag: "600"
        compare:
          op: eq
          value: "600"
        set: true

  - id: '1.9'
    text: "controller-manager.conf file permissions (600)"
    audit: stat -c %a /etc/kubernetes/controller-manager.conf
    remediation: "chmod 600 /etc/kubernetes/controller-manager.conf"
    scored: true
    tests:
      test_items:
      - flag: "600"
        compare:
          op: eq
          value: "600"
        set: true

# ──────────────────────────────────
# 2. API Server (CIS 1.2.x)
# ──────────────────────────────────
- id: '2'
  text: API Server
  checks:
  - id: '2.1'
    text: "--anonymous-auth=false"
    audit: ps aux | grep kube-apiserver | grep -- --anonymous-auth
    remediation: "Set --anonymous-auth=false in kube-apiserver manifest"
    scored: true
    tests:
      test_items:
      - flag: --anonymous-auth
        compare:
          op: eq
          value: "false"
        set: true

  - id: '2.2'
    text: "--token-auth-file not set"
    audit: ps aux | grep kube-apiserver
    remediation: "Remove --token-auth-file from kube-apiserver manifest"
    scored: true
    tests:
      test_items:
      - flag: --token-auth-file
        set: false

  - id: '2.3'
    text: "--kubelet-https=true"
    audit: ps aux | grep kube-apiserver | grep -- --kubelet-https
    remediation: "Set --kubelet-https=true or remove flag (default is true)"
    scored: true
    tests:
      test_items:
      - flag: --kubelet-https
        compare:
          op: noteq
          value: "false"
        set: true

  - id: '2.4'
    text: "--authorization-mode includes RBAC"
    audit: ps aux | grep kube-apiserver | grep -- --authorization-mode
    remediation: "Set --authorization-mode=Node,RBAC"
    scored: true
    tests:
      test_items:
      - flag: --authorization-mode
        compare:
          op: has
          value: "RBAC"
        set: true

  - id: '2.5'
    text: "--authorization-mode does not include AlwaysAllow"
    audit: ps aux | grep kube-apiserver | grep -- --authorization-mode
    remediation: "Remove AlwaysAllow from --authorization-mode"
    scored: true
    tests:
      test_items:
      - flag: --authorization-mode
        compare:
          op: nothave
          value: "AlwaysAllow"
        set: true

  - id: '2.6'
    text: "--kubelet-client-certificate and --kubelet-client-key set"
    audit: ps aux | grep kube-apiserver | grep -- --kubelet-client-certificate
    remediation: "Set --kubelet-client-certificate and --kubelet-client-key"
    scored: true
    tests:
      test_items:
      - flag: --kubelet-client-certificate
        set: true

  - id: '2.7'
    text: "--enable-admission-plugins includes NodeRestriction"
    audit: ps aux | grep kube-apiserver | grep -- --enable-admission-plugins
    remediation: "Add NodeRestriction to --enable-admission-plugins"
    scored: true
    tests:
      test_items:
      - flag: --enable-admission-plugins
        compare:
          op: has
          value: "NodeRestriction"
        set: true

  - id: '2.8'
    text: "--insecure-bind-address not set"
    audit: ps aux | grep kube-apiserver
    remediation: "Remove --insecure-bind-address"
    scored: true
    tests:
      test_items:
      - flag: --insecure-bind-address
        set: false

  - id: '2.9'
    text: "--insecure-port=0"
    audit: ps aux | grep kube-apiserver | grep -- --insecure-port
    remediation: "Set --insecure-port=0"
    scored: true
    tests:
      test_items:
      - flag: --insecure-port
        compare:
          op: eq
          value: "0"
        set: true

  - id: '2.10'
    text: "--secure-port not 0"
    audit: ps aux | grep kube-apiserver | grep -- --secure-port
    remediation: "Set --secure-port=6443 (or non-zero)"
    scored: true
    tests:
      test_items:
      - flag: --secure-port
        compare:
          op: gt
          value: 0
        set: true

  - id: '2.11'
    text: "--audit-log-path set"
    audit: ps aux | grep kube-apiserver | grep -- --audit-log-path
    remediation: "Set --audit-log-path=/var/log/kubernetes/audit.log"
    scored: true
    tests:
      test_items:
      - flag: --audit-log-path
        set: true

  - id: '2.12'
    text: "--audit-log-maxage >= 30"
    audit: ps aux | grep kube-apiserver | grep -- --audit-log-maxage
    remediation: "Set --audit-log-maxage=30"
    scored: true
    tests:
      test_items:
      - flag: --audit-log-maxage
        compare:
          op: gte
          value: 30
        set: true

  - id: '2.13'
    text: "--audit-log-maxbackup >= 10"
    audit: ps aux | grep kube-apiserver | grep -- --audit-log-maxbackup
    remediation: "Set --audit-log-maxbackup=10"
    scored: true
    tests:
      test_items:
      - flag: --audit-log-maxbackup
        compare:
          op: gte
          value: 10
        set: true

  - id: '2.14'
    text: "--audit-log-maxsize >= 100"
    audit: ps aux | grep kube-apiserver | grep -- --audit-log-maxsize
    remediation: "Set --audit-log-maxsize=100"
    scored: true
    tests:
      test_items:
      - flag: --audit-log-maxsize
        compare:
          op: gte
          value: 100
        set: true

  - id: '2.15'
    text: "--service-account-lookup=true"
    audit: ps aux | grep kube-apiserver | grep -- --service-account-lookup
    remediation: "Set --service-account-lookup=true"
    scored: true
    tests:
      test_items:
      - flag: --service-account-lookup
        compare:
          op: eq
          value: "true"
        set: true

  - id: '2.16'
    text: "--service-account-key-file set"
    audit: ps aux | grep kube-apiserver | grep -- --service-account-key-file
    remediation: "Set --service-account-key-file to SA public key"
    scored: true
    tests:
      test_items:
      - flag: --service-account-key-file
        set: true

  - id: '2.17'
    text: "--etcd-certfile and --etcd-keyfile set"
    audit: ps aux | grep kube-apiserver | grep -- --etcd-certfile
    remediation: "Set --etcd-certfile and --etcd-keyfile for mTLS to etcd"
    scored: true
    tests:
      test_items:
      - flag: --etcd-certfile
        set: true

  - id: '2.18'
    text: "--tls-cert-file and --tls-private-key-file set"
    audit: ps aux | grep kube-apiserver | grep -- --tls-cert-file
    remediation: "Set TLS certificate and key for API server"
    scored: true
    tests:
      test_items:
      - flag: --tls-cert-file
        set: true

  - id: '2.19'
    text: "--encryption-provider-config set (Secrets at rest)"
    audit: ps aux | grep kube-apiserver | grep -- --encryption-provider-config
    remediation: "Set --encryption-provider-config for encrypting Secrets at rest"
    scored: true
    tests:
      test_items:
      - flag: --encryption-provider-config
        set: true

  - id: '2.20'
    text: "--deny-service-external-ips set"
    audit: ps aux | grep kube-apiserver | grep -- --deny-service-external-ips
    remediation: "Set --deny-service-external-ips"
    scored: true
    tests:
      test_items:
      - flag: --deny-service-external-ips
        set: true

# ──────────────────────────────────
# 3. Controller Manager (CIS 1.3.x)
# ──────────────────────────────────
- id: '3'
  text: Controller Manager
  checks:
  - id: '3.1'
    text: "--terminated-pod-gc-threshold set"
    audit: ps aux | grep kube-controller-manager | grep -- --terminated-pod-gc-threshold
    remediation: "Set --terminated-pod-gc-threshold=12500"
    scored: true
    tests:
      test_items:
      - flag: --terminated-pod-gc-threshold
        set: true

  - id: '3.2'
    text: "--profiling=false"
    audit: ps aux | grep kube-controller-manager | grep -- --profiling
    remediation: "Set --profiling=false"
    scored: true
    tests:
      test_items:
      - flag: --profiling
        compare:
          op: eq
          value: "false"
        set: true

  - id: '3.3'
    text: "--use-service-account-credentials=true"
    audit: ps aux | grep kube-controller-manager | grep -- --use-service-account-credentials
    remediation: "Set --use-service-account-credentials=true"
    scored: true
    tests:
      test_items:
      - flag: --use-service-account-credentials
        compare:
          op: eq
          value: "true"
        set: true

  - id: '3.4'
    text: "--service-account-private-key-file set"
    audit: ps aux | grep kube-controller-manager | grep -- --service-account-private-key-file
    remediation: "Set --service-account-private-key-file"
    scored: true
    tests:
      test_items:
      - flag: --service-account-private-key-file
        set: true

  - id: '3.5'
    text: "--root-ca-file set"
    audit: ps aux | grep kube-controller-manager | grep -- --root-ca-file
    remediation: "Set --root-ca-file"
    scored: true
    tests:
      test_items:
      - flag: --root-ca-file
        set: true

  - id: '3.6'
    text: "--bind-address=127.0.0.1"
    audit: ps aux | grep kube-controller-manager | grep -- --bind-address
    remediation: "Set --bind-address=127.0.0.1"
    scored: true
    tests:
      test_items:
      - flag: --bind-address
        compare:
          op: eq
          value: "127.0.0.1"
        set: true

  - id: '3.7'
    text: "RotateKubeletServerCertificate enabled"
    audit: ps aux | grep kube-controller-manager | grep -- --feature-gates
    remediation: "Set --feature-gates=RotateKubeletServerCertificate=true"
    scored: true
    tests:
      test_items:
      - flag: --feature-gates
        compare:
          op: has
          value: "RotateKubeletServerCertificate=true"
        set: true

# ──────────────────────────────────
# 4. Scheduler (CIS 1.4.x)
# ──────────────────────────────────
- id: '4'
  text: Scheduler
  checks:
  - id: '4.1'
    text: "--profiling=false"
    audit: ps aux | grep kube-scheduler | grep -- --profiling
    remediation: "Set --profiling=false"
    scored: true
    tests:
      test_items:
      - flag: --profiling
        compare:
          op: eq
          value: "false"
        set: true

  - id: '4.2'
    text: "--bind-address=127.0.0.1"
    audit: ps aux | grep kube-scheduler | grep -- --bind-address
    remediation: "Set --bind-address=127.0.0.1"
    scored: true
    tests:
      test_items:
      - flag: --bind-address
        compare:
          op: eq
          value: "127.0.0.1"
        set: true

# ──────────────────────────────────
# 5. ETCD (CIS 2.x)
# ──────────────────────────────────
- id: '5'
  text: ETCD
  checks:
  - id: '5.1'
    text: "--cert-file and --key-file set (client TLS)"
    audit: ps aux | grep etcd | grep -- --cert-file
    remediation: "Set --cert-file and --key-file for etcd TLS"
    scored: true
    tests:
      test_items:
      - flag: --cert-file
        set: true

  - id: '5.2'
    text: "--client-cert-auth=true"
    audit: ps aux | grep etcd | grep -- --client-cert-auth
    remediation: "Set --client-cert-auth=true"
    scored: true
    tests:
      test_items:
      - flag: --client-cert-auth
        compare:
          op: eq
          value: "true"
        set: true

  - id: '5.3'
    text: "--auto-tls=false"
    audit: ps aux | grep etcd | grep -- --auto-tls
    remediation: "Set --auto-tls=false (no self-signed certs)"
    scored: true
    tests:
      test_items:
      - flag: --auto-tls
        compare:
          op: eq
          value: "false"
        set: true

  - id: '5.4'
    text: "--peer-cert-file and --peer-key-file set"
    audit: ps aux | grep etcd | grep -- --peer-cert-file
    remediation: "Set peer TLS certs for etcd cluster"
    scored: true
    tests:
      test_items:
      - flag: --peer-cert-file
        set: true

  - id: '5.5'
    text: "--peer-client-cert-auth=true"
    audit: ps aux | grep etcd | grep -- --peer-client-cert-auth
    remediation: "Set --peer-client-cert-auth=true"
    scored: true
    tests:
      test_items:
      - flag: --peer-client-cert-auth
        compare:
          op: eq
          value: "true"
        set: true

  - id: '5.6'
    text: "--peer-auto-tls=false"
    audit: ps aux | grep etcd | grep -- --peer-auto-tls
    remediation: "Set --peer-auto-tls=false"
    scored: true
    tests:
      test_items:
      - flag: --peer-auto-tls
        compare:
          op: eq
          value: "false"
        set: true

  - id: '5.7'
    text: "Unique CA for etcd"
    audit: ps aux | grep etcd | grep -- --trusted-ca-file
    remediation: "Set --trusted-ca-file to etcd-specific CA"
    scored: true
    tests:
      test_items:
      - flag: --trusted-ca-file
        set: true

# ──────────────────────────────────
# 6. TLS Hardening (CIS 1.2.22, 1.2.29)
# ──────────────────────────────────
- id: '6'
  text: TLS Hardening
  checks:
  - id: '6.1'
    text: "--tls-min-version=VersionTLS12"
    audit: ps aux | grep kube-apiserver | grep -- --tls-min-version
    remediation: "Set --tls-min-version=VersionTLS12 to disable TLS 1.0/1.1"
    scored: true
    tests:
      test_items:
      - flag: --tls-min-version
        compare:
          op: eq
          value: "VersionTLS12"
        set: true

  - id: '6.2'
    text: "--tls-cipher-suites set with secure ciphers"
    audit: ps aux | grep kube-apiserver | grep -- --tls-cipher-suites
    remediation: |
      Set --tls-cipher-suites=TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,
      TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,
      TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,
      TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
    scored: true
    tests:
      test_items:
      - flag: --tls-cipher-suites
        set: true

  - id: '6.3'
    text: "etcd --cipher-suites set"
    audit: ps aux | grep etcd | grep -- --cipher-suites
    remediation: "Set etcd --cipher-suites with FIPS-compatible ciphers"
    scored: true
    tests:
      test_items:
      - flag: --cipher-suites
        set: true

  - id: '6.4'
    text: "etcd --listen-client-urls not 0.0.0.0"
    audit: ps aux | grep etcd | grep -- --listen-client-urls
    remediation: "Set --listen-client-urls=https://127.0.0.1:2379,https://<trusted-ip>:2379"
    scored: true
    tests:
      test_items:
      - flag: --listen-client-urls
        compare:
          op: nothave
          value: "0.0.0.0"
        set: true

# ──────────────────────────────────
# 7. Kubelet Hardening (CIS 4.2.x)
# ──────────────────────────────────
- id: '7'
  text: Kubelet
  checks:
  - id: '7.1'
    text: "--anonymous-auth=false"
    audit: ps aux | grep kubelet | grep -- --anonymous-auth
    remediation: "Set kubelet --anonymous-auth=false"
    scored: true
    tests:
      test_items:
      - flag: --anonymous-auth
        compare:
          op: eq
          value: "false"
        set: true

  - id: '7.2'
    text: "--authorization-mode not AlwaysAllow"
    audit: ps aux | grep kubelet | grep -- --authorization-mode
    remediation: "Set kubelet --authorization-mode=Webhook"
    scored: true
    tests:
      test_items:
      - flag: --authorization-mode
        compare:
          op: nothave
          value: "AlwaysAllow"
        set: true

  - id: '7.3'
    text: "--client-ca-file set"
    audit: ps aux | grep kubelet | grep -- --client-ca-file
    remediation: "Set kubelet --client-ca-file for client certificate verification"
    scored: true
    tests:
      test_items:
      - flag: --client-ca-file
        set: true

  - id: '7.4'
    text: "--read-only-port=0"
    audit: ps aux | grep kubelet | grep -- --read-only-port
    remediation: "Set kubelet --read-only-port=0 to disable unauthenticated read-only port"
    scored: true
    tests:
      test_items:
      - flag: --read-only-port
        compare:
          op: eq
          value: "0"
        set: true

  - id: '7.5'
    text: "--protect-kernel-defaults=true"
    audit: ps aux | grep kubelet | grep -- --protect-kernel-defaults
    remediation: "Set kubelet --protect-kernel-defaults=true (CIS 4.2.6)"
    scored: true
    tests:
      test_items:
      - flag: --protect-kernel-defaults
        compare:
          op: eq
          value: "true"
        set: true

  - id: '7.6'
    text: "--rotate-certificates=true"
    audit: ps aux | grep kubelet | grep -- --rotate-certificates
    remediation: "Set kubelet --rotate-certificates=true"
    scored: true
    tests:
      test_items:
      - flag: --rotate-certificates
        compare:
          op: eq
          value: "true"
        set: true

  - id: '7.7'
    text: "--event-qps set appropriately (CIS 4.2.9)"
    audit: ps aux | grep kubelet | grep -- --event-qps
    remediation: "Set --event-qps=0 for unlimited or appropriate value for event recording"
    scored: true
    tests:
      test_items:
      - flag: --event-qps
        set: true
