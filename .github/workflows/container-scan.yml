name: Container Image Security

on:
  push:
    branches: [main, develop]
    paths:
      - 'Dockerfile*'
      - 'docker/**'
      - 'docker-compose*.yml'
      - 'requirements.txt'
      - 'trivy/**'
  pull_request:
    branches: [main]
  schedule:
    # Еженедельное сканирование по понедельникам в 06:00 UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      fail_on_severity:
        description: 'Минимальная серьёзность для блокировки'
        required: false
        default: 'CRITICAL,HIGH'
        type: choice
        options:
          - 'CRITICAL'
          - 'CRITICAL,HIGH'
          - 'CRITICAL,HIGH,MEDIUM'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  TRIVY_VERSION: '0.58.0'

jobs:
  # ──────────────────────────────────────────────
  # 1. Сканирование файловой системы (IaC + зависимости)
  # ──────────────────────────────────────────────
  filesystem-scan:
    name: Сканирование файловой системы
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Сканирование FS — уязвимости зависимостей
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          trivyignores: 'trivy/.trivyignore'

      - name: Сканирование FS — мисконфигурации (Dockerfile, K8s, etc.)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'CRITICAL,HIGH,MEDIUM'
          exit-code: '0'
          trivyignores: 'trivy/.trivyignore'

      - name: Загрузка результатов FS в GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'

      - name: Загрузка результатов IaC в GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-config.sarif'
          category: 'trivy-misconfig'

      - name: Сохранение артефактов
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-fs-reports
          path: |
            trivy-fs.sarif
            trivy-config.sarif
          retention-days: 30

  # ──────────────────────────────────────────────
  # 2. Сборка и сканирование Docker-образа
  # ──────────────────────────────────────────────
  image-scan:
    name: Сканирование Docker-образа
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
      security-events: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Сборка образа (без push)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: test-hard:scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Сканирование образа — уязвимости
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'test-hard:scan'
          format: 'json'
          output: 'trivy-image.json'
          severity: 'CRITICAL,HIGH,MEDIUM'
          ignore-unfixed: true
          trivyignores: 'trivy/.trivyignore'
          exit-code: '0'

      - name: Сканирование образа — SARIF для GitHub
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'test-hard:scan'
          format: 'sarif'
          output: 'trivy-image.sarif'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          trivyignores: 'trivy/.trivyignore'
          exit-code: '0'

      - name: Загрузка SARIF в GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        if: always()
        with:
          sarif_file: 'trivy-image.sarif'
          category: 'trivy-image'

      # ---- Блокировка при наличии критических уязвимостей ----
      - name: "Блокировка: проверка CRITICAL уязвимостей"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'test-hard:scan'
          format: 'table'
          severity: ${{ github.event.inputs.fail_on_severity || 'CRITICAL,HIGH' }}
          ignore-unfixed: true
          trivyignores: 'trivy/.trivyignore'
          exit-code: '1'

      - name: Сохранение отчёта
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-image-report
          path: |
            trivy-image.json
            trivy-image.sarif
          retention-days: 30

  # ──────────────────────────────────────────────
  # 3. Генерация SBOM
  # ──────────────────────────────────────────────
  sbom:
    name: Генерация SBOM
    runs-on: ubuntu-latest
    needs: [image-scan]
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Сборка образа
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: test-hard:sbom
          cache-from: type=gha

      - name: Установка Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin v${{ env.TRIVY_VERSION }}

      # CycloneDX SBOM
      - name: Генерация CycloneDX SBOM
        run: |
          trivy image --format cyclonedx --output sbom-cyclonedx.json test-hard:sbom

      # SPDX SBOM
      - name: Генерация SPDX SBOM
        run: |
          trivy image --format spdx-json --output sbom-spdx.json test-hard:sbom

      # Анализ лицензий
      - name: Проверка лицензий
        run: |
          trivy image --scanners license \
            --severity HIGH,CRITICAL \
            --format table \
            test-hard:sbom || true

      - name: Сохранение SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: |
            sbom-cyclonedx.json
            sbom-spdx.json
          retention-days: 90

  # ──────────────────────────────────────────────
  # 4. Сканирование базовых образов из docker-compose
  # ──────────────────────────────────────────────
  base-images-scan:
    name: Сканирование базовых образов
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        image:
          - 'debian:12-slim'
          - 'registry.fedoraproject.org/fedora:40'
          - 'quay.io/centos/centos:stream9'
          - 'ubuntu:22.04'
          - 'prom/prometheus:v2.52.0'
          - 'grafana/grafana:11.0.0'
          - 'prom/alertmanager:v0.27.0'
          - 'grafana/loki:2.9.0'
          - 'falcosecurity/falco-no-driver:0.38.1'
    steps:
      - name: Checkout (для .trivyignore)
        uses: actions/checkout@v4

      - name: Загрузка образа ${{ matrix.image }}
        run: docker pull ${{ matrix.image }}
        continue-on-error: true

      - name: Сканирование ${{ matrix.image }}
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ matrix.image }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'
        continue-on-error: true

  # ──────────────────────────────────────────────
  # 5. Итоговый отчёт
  # ──────────────────────────────────────────────
  report:
    name: Сводный отчёт
    runs-on: ubuntu-latest
    needs: [filesystem-scan, image-scan, sbom, base-images-scan]
    if: always()
    steps:
      - name: Скачивание всех артефактов
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
        continue-on-error: true

      - name: Формирование сводки
        env:
          FS_RESULT: ${{ needs.filesystem-scan.result }}
          IMAGE_RESULT: ${{ needs.image-scan.result }}
          SBOM_RESULT: ${{ needs.sbom.result }}
          BASE_RESULT: ${{ needs.base-images-scan.result }}
        run: |
          echo "## Container Image Security Report" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Проверка | Статус |" >> "$GITHUB_STEP_SUMMARY"
          echo "|----------|--------|" >> "$GITHUB_STEP_SUMMARY"

          fs_status="Ошибка"; [[ "$FS_RESULT" == "success" ]] && fs_status="Пройдено"
          img_status="Заблокировано"; [[ "$IMAGE_RESULT" == "success" ]] && img_status="Пройдено"
          sbom_status="Пропущено"; [[ "$SBOM_RESULT" == "success" ]] && sbom_status="Сгенерирован"
          base_status="Есть проблемы"; [[ "$BASE_RESULT" == "success" ]] && base_status="Просканированы"

          echo "| Файловая система | ${fs_status} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Docker-образ | ${img_status} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| SBOM | ${sbom_status} |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Базовые образы | ${base_status} |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [[ -f trivy-image.json ]]; then
            echo "### Уязвимости образа" >> "$GITHUB_STEP_SUMMARY"
            python3 << 'PYEOF' >> "$GITHUB_STEP_SUMMARY"
          import json
          with open("trivy-image.json") as f:
              data = json.load(f)
          counts = {"CRITICAL": 0, "HIGH": 0, "MEDIUM": 0, "LOW": 0}
          for r in data.get("Results", []):
              for v in (r.get("Vulnerabilities") or []):
                  s = v.get("Severity", "UNKNOWN")
                  if s in counts:
                      counts[s] += 1
          total = sum(counts.values())
          print("| Серьёзность | Количество |")
          print("|-------------|------------|")
          for s in ["CRITICAL", "HIGH", "MEDIUM", "LOW"]:
              print(f"| {s} | {counts[s]} |")
          print(f"| **Всего** | **{total}** |")
          PYEOF
          fi
