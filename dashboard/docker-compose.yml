services:
  # Dashboard Backend API
  dashboard-backend:
    build: ./backend
    image: test-hard/dashboard-backend:${VERSION:-latest}
    container_name: dashboard-backend
    environment:
      - DATABASE_URL=sqlite+aiosqlite:///./data/dashboard.db
      - SECRET_KEY=${DASHBOARD_SECRET_KEY:-change-me-in-production}
      - DEBUG=${DEBUG:-false}
      - PROMETHEUS_URL=http://prometheus:9090
      - GRAFANA_URL=http://grafana:3000
      - LOKI_URL=http://loki:3100
      - TEMPO_URL=http://tempo:3200
      - OTLP_ENDPOINT=http://tempo:4317
      - TRACING_ENABLED=true
      - DOCKER_HOST=tcp://docker-proxy:2375
    volumes:
      - dashboard-data:/app/data
      - ../reports:/app/reports
    ports:
      - "8000:8000"
    networks:
      - default
      - scanner-net
    depends_on:
      - docker-proxy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M

  # Dashboard Frontend (production build served by nginx)
  dashboard-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: test-hard/dashboard-frontend:${VERSION:-latest}
    container_name: dashboard-frontend
    ports:
      - "3001:80"
    depends_on:
      - dashboard-backend
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

  # Docker Socket Proxy (shared with main compose)
  docker-proxy:
    image: tecnativa/docker-socket-proxy:0.1.2
    container_name: dashboard-docker-proxy
    environment:
      CONTAINERS: 1
      EXEC: 1
      IMAGES: 1
      INFO: 1
      NETWORKS: 1
      POST: 1
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - scanner-net
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

volumes:
  dashboard-data:

networks:
  scanner-net:
    driver: bridge
